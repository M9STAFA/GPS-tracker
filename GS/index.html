<!DOCTYPE html>
<html lang="fa">
<head>
    <title>Ø±Ø¯ÛŒØ§Ø¨ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§ØªÙˆØ¨ÙˆØ³â€ŒÙ‡Ø§ (Ù¾Ø±ÙˆÚ˜Ù‡ bus-tracker-app-usb)</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1e1e2f; /* Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ ØªÛŒØ±Ù‡ Ù…Ø§ÛŒÙ„ Ø¨Ù‡ Ø³Ø±Ù…Ù‡â€ŒØ§ÛŒ */
            --surface-color: #27293d; /* Ø³Ø·Ø­ Ú©Ù…ÛŒ Ø±ÙˆØ´Ù†â€ŒØªØ± Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ùˆ Ù‡Ø¯Ø±/ÙÙˆØªØ± */
            --primary-accent: #6271c2; /* Ø¢Ø¨ÛŒ Ø¨Ù†ÙØ´ Ø¨Ø±Ø§ÛŒ ØªØ§Ú©ÛŒØ¯ */
            --secondary-accent: #ffc107; /* Ø²Ø±Ø¯ Ú©Ù‡Ø±Ø¨Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ø²Ø¦ÛŒØ§Øª Ø®Ø§Øµ ÛŒØ§ Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) */
            --text-color: #e0e0e5; /* Ø±Ù†Ú¯ Ù…ØªÙ† Ø§ØµÙ„ÛŒ Ø±ÙˆØ´Ù† */
            --text-color-muted: #a0a0b0; /* Ø±Ù†Ú¯ Ù…ØªÙ† Ú©Ù…â€ŒØ§Ù‡Ù…ÛŒØªâ€ŒØªØ± */
            --border-color: #3a3c53; /* Ø±Ù†Ú¯ Ø¨ÙˆØ±Ø¯Ø±Ù‡Ø§ */
            --border-radius: 8px;
            --header-height: 60px;
            --footer-height: 30px;
            --font-family: 'Vazirmatn', 'Tahoma', sans-serif;
            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.2);
            --shadow-strong: 0 6px 18px rgba(0, 0, 0, 0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            direction: rtl;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background-color: var(--surface-color);
            color: var(--text-color);
            padding: 0 20px;
            text-align: center;
            font-size: 1.5em; /* Ú©Ù…ÛŒ Ú©ÙˆÚ†Ú©ØªØ± Ø¨Ø±Ø§ÛŒ Ø¸Ø±Ø§ÙØª */
            font-weight: 600; /* ÙˆØ²Ù† Ù…ØªÙˆØ³Ø· Ø¨Ø±Ø§ÛŒ Ø¹Ù†ÙˆØ§Ù† */
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid var(--border-color);
            /* box-shadow: var(--shadow-soft); */
        }
        .header-icon {
            font-size: 1.2em;
            margin-left: 10px;
            color: var(--primary-accent);
        }

        #map {
            height: calc(100vh - var(--header-height) - var(--footer-height));
            width: 100%;
            flex-grow: 1;
        }
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø²Ù…Ø§Ù†ÛŒ Ú©Ù‡ Ù†Ù‚Ø´Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø³Øª */
        #map:empty {
            background-color: #222; /* ÛŒÚ© Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ ØªÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù‚Ø´Ù‡ Ù‚Ø¨Ù„ Ø§Ø² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: var(--text-color-muted);
        }
        #map:empty::before {
            content: "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ù‚Ø´Ù‡...";
        }


        /* Ø§Ø³ØªØ§ÛŒÙ„ Ù¾Ø§Ù¾â€ŒØ¢Ù¾â€ŒÙ‡Ø§ÛŒ Leaflet Ø¨Ø±Ø§ÛŒ ØªÙ… ØªÛŒØ±Ù‡ */
        .leaflet-popup-content-wrapper {
            background: var(--surface-color) !important;
            color: var(--text-color) !important;
            border-radius: var(--border-radius) !important;
            box-shadow: var(--shadow-strong) !important;
            border: 1px solid var(--border-color);
        }
        .leaflet-popup-content {
            font-family: var(--font-family) !important;
            font-size: 14px !important;
            line-height: 1.7 !important;
            margin: 12px !important;
        }
        .leaflet-popup-content b {
            color: var(--primary-accent) !important;
            font-weight: 600;
        }
        .leaflet-popup-tip-container {
            /* Ø¨Ø±Ø§ÛŒ Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† ÛŒØ§ Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ù¾ÛŒÚ©Ø§Ù† Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² */
        }
        .leaflet-popup-tip {
            background: var(--surface-color) !important;
            border-bottom-color: var(--border-color) !important; /* Ø§Ú¯Ø± Ù¾ÛŒÚ©Ø§Ù† Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ† Ø§Ø´Ø§Ø±Ù‡ Ø¯Ø§Ø±Ø¯ */
        }
        .leaflet-container a.leaflet-popup-close-button {
            color: var(--text-color-muted) !important;
            padding: 8px 8px 0 0 !important;
        }
        .leaflet-container a.leaflet-popup-close-button:hover {
            color: var(--text-color) !important;
        }


        .last-updated-container {
            position: fixed;
            bottom: calc(var(--footer-height) + 12px);
            right: 12px;
            background-color: var(--surface-color);
            color: var(--text-color-muted);
            padding: 7px 15px;
            border-radius: var(--border-radius);
            font-size: 0.8em;
            z-index: 1000;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-soft);
            opacity: 0.9;
            transition: opacity 0.3s ease;
        }
        .last-updated-container:hover {
            opacity: 1;
        }

        .footer {
            background-color: var(--surface-color);
            color: var(--text-color-muted);
            padding: 0 20px;
            text-align: center;
            font-size: 0.75em; /* Ø¨Ø³ÛŒØ§Ø± Ú©ÙˆÚ†Ú© Ø¨Ø±Ø§ÛŒ Ø¸Ø±Ø§ÙØª */
            font-weight: 300; /* ÙˆØ²Ù† Ø³Ø¨Ú© */
            height: var(--footer-height);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            border-top: 1px solid var(--border-color);
            z-index: 1001;
        }
    </style>
</head>
<body>

<div class="header">
    <span class="header-icon">ğŸ›°ï¸</span> Ø±Ø¯ÛŒØ§Ø¨ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§ØªÙˆØ¨ÙˆØ³â€ŒÙ‡Ø§
</div>

<div id="map"></div>

<div id="lastUpdated" class="last-updated-container">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡...</div>

<div class="footer">
    Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ù‡ Ø¯Ø³Øª Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ø¯Ø§Ù†Ø´Ú©Ø¯Ù‡ Ø¨Ø±Ù‚ Ùˆ Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ± - Ù†Ø³Ø®Ù‡ 2.0
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyCCNBFlmY3akMMsNoGecKTrOR_LMaHJ-6A", // Ù„Ø·ÙØ§Ù‹ Ú©Ù„ÛŒØ¯ ÙˆØ§Ù‚Ø¹ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯
      authDomain: "bus-tracker-app-usb.firebaseapp.com",
      projectId: "bus-tracker-app-usb",
      storageBucket: "bus-tracker-app-usb.firebasestorage.app",
      messagingSenderId: "652452426183",
      appId: "1:652452426183:web:a0014cc421c727bf24a9e2",
      measurementId: "G-C218VLB61E"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const locationsCollection = db.collection("locations");

    var map = L.map('map', {
        // attributionControl: false // Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù Attribution Ø§Ø² Ù¾Ø§ÛŒÛŒÙ† Ù†Ù‚Ø´Ù‡ Ø§Ú¯Ø± Ø¨Ø®ÙˆØ§Ù‡ÛŒØ¯
    }).setView([32.4279, 53.6880], 6);

    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù‚Ø´Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒØŒ Ø§Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ø¨Ø§ ØªÙ… ØªÛŒØ±Ù‡ Ø¹Ø§Ù„ÛŒ Ø§Ø³Øª)
    // CartoDB Dark Matter:
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);
    // Ø§Ú¯Ø± ØªØ§ÛŒÙ„ Ø±ÙˆØ´Ù† Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø±Ø§ ØªØ±Ø¬ÛŒØ­ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯:
    // L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    //     maxZoom: 19,
    //     attribution: 'Â© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    // }).addTo(map);


    var busMarkers = {};
    const lastDeviceUpdateTimes = {};

    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¢ÛŒÚ©ÙˆÙ† Ù‚Ø¨Ù„ÛŒ Ú©Ù‡ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ú©Ù„ÛŒØ¯ Ù†Ø¯Ø§Ø±Ø¯
    var busIcon = L.icon({
        iconUrl: 'https://img.icons8.com/ios-filled/50/FFFFFF/bus.png', // Ø¢ÛŒÚ©ÙˆÙ† Ø³ÙÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ú©Ù†ØªØ±Ø§Ø³Øª Ø¨Ø§ Ù†Ù‚Ø´Ù‡ ØªÛŒØ±Ù‡ ÛŒØ§ Ø±ÙˆØ´Ù†
        iconSize: [30, 30], // Ú©Ù…ÛŒ Ú©ÙˆÚ†Ú©ØªØ±
        iconAnchor: [15, 30],
        popupAnchor: [0, -28]
    });


    function formatReadableTimestamp(isoString) {
        if (!isoString) return 'Ù†Ø§Ù…Ø´Ø®Øµ';
        try {
            const date = new Date(isoString);
            return date.toLocaleString('fa-IR', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        } catch (e) {
            console.warn("Ø®Ø·Ø§ Ø¯Ø± ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ®:", isoString, e);
            return 'Ù†Ø§Ù…Ø´Ø®Øµ';
        }
    }

    function updateMarkersForDevice(doc) {
        const locationData = doc.data();
        const deviceId = locationData.deviceId || doc.id;
        const lat = locationData.latitude;
        const lng = locationData.longitude;
        const speed = locationData.speedKmph;
        const gpsTimestamp = locationData.gpsTimestamp;

        if (typeof lat !== 'number' || typeof lng !== 'number') {
            console.warn("Ø¯Ø§Ø¯Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù†Ø§Ù…Ø¹ØªØ¨Ø±:", deviceId, locationData);
            return;
        }

        lastDeviceUpdateTimes[deviceId] = new Date(gpsTimestamp || Date.now());
        updateOverallLastUpdated();

        var latLng = L.latLng(lat, lng);
        var popupContent = `<b><span style="font-size: 1.1em;">Ø´Ù†Ø§Ø³Ù‡ Ø§ØªÙˆØ¨ÙˆØ³: ${deviceId}</span></b><br>
                            Ø³Ø±Ø¹Øª: ${speed !== undefined ? parseFloat(speed).toFixed(1) + ' km/h' : 'N/A'}<br>
                            Ø²Ù…Ø§Ù† GPS: ${formatReadableTimestamp(gpsTimestamp)}`;

        if (busMarkers[deviceId]) {
            busMarkers[deviceId].setLatLng(latLng).setPopupContent(popupContent);
        } else {
            busMarkers[deviceId] = L.marker(latLng, {icon: busIcon}).addTo(map).bindPopup(popupContent);
        }
    }

    function updateOverallLastUpdated() {
        let mostRecentTime = 0;
        for (const device in lastDeviceUpdateTimes) {
            if (lastDeviceUpdateTimes[device].getTime() > mostRecentTime) {
                mostRecentTime = lastDeviceUpdateTimes[device].getTime();
            }
        }

        const lastUpdatedElement = document.getElementById('lastUpdated');
        if (mostRecentTime > 0) {
            lastUpdatedElement.textContent = 'Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ' + new Date(mostRecentTime).toLocaleTimeString('fa-IR', {hour12: false});
        } else {
            lastUpdatedElement.textContent = 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø§Ø¯Ù‡...';
        }
    }

    locationsCollection.onSnapshot(snapshot => {
        let newOrModifiedDocs = false;
        snapshot.docChanges().forEach(change => {
            const doc = change.doc;
            const deviceId = doc.data().deviceId || doc.id;

            if (change.type === "added" || change.type === "modified") {
                newOrModifiedDocs = true;
                updateMarkersForDevice(doc);
            }
            if (change.type === "removed") {
                if (busMarkers[deviceId]) {
                    map.removeLayer(busMarkers[deviceId]);
                    delete busMarkers[deviceId];
                    delete lastDeviceUpdateTimes[deviceId];
                    updateOverallLastUpdated();
                }
            }
        });

        if (newOrModifiedDocs && Object.keys(busMarkers).length > 0) {
           try {
               var group = new L.featureGroup(Object.values(busMarkers));
               map.fitBounds(group.getBounds().pad(0.25)); // Ù¾Ø¯ÛŒÙ†Ú¯ Ú©Ù…ØªØ± Ø¨Ø±Ø§ÛŒ Ø­Ø³ ÙÛŒØªâ€ŒØªØ± Ø¨ÙˆØ¯Ù†
           } catch(e) {
               console.warn("Ø®Ø·Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ… Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ù†Ù‚Ø´Ù‡: ", e);
           }
        } else if (Object.keys(busMarkers).length === 0) {
            map.setView([32.4279, 53.6880], 6);
        }

    }, error => {
        console.error("Ø®Ø·Ø§ Ø¯Ø± Firestore: ", error);
        document.getElementById('lastUpdated').textContent = 'âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·.';
    });
</script>

</body>
</html>
