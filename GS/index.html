<!DOCTYPE html>
<html lang="fa">
<head>
    <title>Ø±Ø¯ÛŒØ§Ø¨ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø§ØªÙˆØ¨ÙˆØ³â€ŒÙ‡Ø§ (Ù¾Ø±ÙˆÚ˜Ù‡ bus-tracker-app-usb)</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff; /* Ø¢Ø¨ÛŒ Ù…Ø¯Ø±Ù† */
            --secondary-color: #6c757d; /* Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ø®Ù†Ø«ÛŒ */
            --light-bg: #f8f9fa;
            --white-color: #ffffff;
            --dark-text: #343a40;
            --border-radius: 8px;
            --header-height: 65px;
            --footer-height: 35px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Vazirmatn', 'Tahoma', sans-serif; /* Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ÙÙˆÙ†Øª ÙˆØ²ÛŒØ±Ù…ØªÙ† */
            margin: 0;
            padding: 0;
            direction: rtl;
            background-color: var(--light-bg);
            color: var(--dark-text);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³Ú©Ø±ÙˆÙ„ Ø§Ø¶Ø§ÙÛŒ */
        }

        .header {
            background-color: var(--primary-color);
            color: var(--white-color);
            padding: 18px 15px;
            text-align: center;
            font-size: 1.6em;
            font-weight: 700;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #map {
            height: calc(100vh - var(--header-height) - var(--footer-height));
            width: 100%;
            flex-grow: 1; /* Ø§Ø¬Ø§Ø²Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ù†Ù‚Ø´Ù‡ ÙØ¶Ø§ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ø±Ø§ Ù¾Ø± Ú©Ù†Ø¯ */
        }

        .leaflet-popup-content-wrapper {
            border-radius: var(--border-radius) !important;
            box-shadow: 0 1px 5px rgba(0,0,0,0.15);
        }
        .leaflet-popup-content {
            font-family: 'Vazirmatn', 'Tahoma', sans-serif;
            font-size: 14px;
            line-height: 1.6;
        }
        .leaflet-popup-content b {
            color: var(--primary-color);
        }

        .last-updated-container {
            position: fixed;
            bottom: calc(var(--footer-height) + 15px); /* Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² ÙÙˆØªØ± */
            right: 15px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: var(--border-radius);
            font-size: 0.85em; /* Ú©Ù…ÛŒ Ú©ÙˆÚ†Ú©ØªØ± Ø¨Ø±Ø§ÛŒ Ø¸Ø±Ø§ÙØª */
            z-index: 1000;
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
            color: var(--dark-text);
            border: 1px solid #eee;
        }

        .footer {
            background-color: #343a40; /* Ø±Ù†Ú¯ ØªÛŒØ±Ù‡â€ŒØªØ± Ø¨Ø±Ø§ÛŒ ÙÙˆØªØ± */
            color: var(--white-color);
            padding: 8px 0;
            text-align: center;
            font-size: 0.85em;
            height: var(--footer-height);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            z-index: 1001; /* Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø¢Ù¾Ø¯ÛŒØªØŒ Ø§Ú¯Ø± Ù‡Ù…Ù¾ÙˆØ´Ø§Ù†ÛŒ Ù…Ù…Ú©Ù† Ø¨ÙˆØ¯ */
        }
    </style>
</head>
<body>

<div class="header">ğŸ“ Ø±Ø¯ÛŒØ§Ø¨ Ø¢Ù†Ù„Ø§ÛŒÙ† Ø§ØªÙˆØ¨ÙˆØ³â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡</div>

<div id="map"></div>

<div id="lastUpdated" class="last-updated-container">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡...</div>

<div class="footer">
    Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ù‡ Ø¯Ø³Øª Ø¯Ø§Ù†Ø´Ø¬ÙˆÙ‡Ø§ÛŒ Ø¯Ø§Ù†Ø´Ú©Ø¯Ù‡ Ø¨Ø±Ù‚ Ùˆ Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ±
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyCCNBFlmY3akMMsNoGecKTrOR_LMaHJ-6A", // Ù„Ø·ÙØ§Ù‹ Ú©Ù„ÛŒØ¯ ÙˆØ§Ù‚Ø¹ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯
      authDomain: "bus-tracker-app-usb.firebaseapp.com",
      projectId: "bus-tracker-app-usb",
      storageBucket: "bus-tracker-app-usb.firebasestorage.app",
      messagingSenderId: "652452426183",
      appId: "1:652452426183:web:a0014cc421c727bf24a9e2",
      measurementId: "G-C218VLB61E"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const locationsCollection = db.collection("locations");

    var map = L.map('map').setView([32.4279, 53.6880], 6); // Ù…Ø±Ú©Ø² Ø§ÛŒØ±Ø§Ù† Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù¾ÛŒØ´â€ŒÙØ±Ø¶

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var busMarkers = {}; // Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù…Ø§Ø±Ú©Ø±Ù‡Ø§ÛŒ Ø§ØªÙˆØ¨ÙˆØ³â€ŒÙ‡Ø§
    const lastDeviceUpdateTimes = {}; // Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø¢Ø®Ø±ÛŒÙ† Ø²Ù…Ø§Ù† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡Ø± Ø¯Ø³ØªÚ¯Ø§Ù‡

    // Ø¢ÛŒÚ©ÙˆÙ† Ø³ÙØ§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ØªÙˆØ¨ÙˆØ³ Ø¨Ø§ Ø·Ø±Ø§Ø­ÛŒ Ù…Ø¯Ø±Ù†â€ŒØªØ±
    var busIcon = L.icon({
        iconUrl: 'https://api.geoapify.com/v1/icon/?type=material&color=%23007bff&icon=bus&iconType=awesome&scaleFactor=2&apiKey=YOUR_GEOAPIFY_KEY', // Ø¢ÛŒÚ©ÙˆÙ† Ù…Ø¯Ø±Ù†â€ŒØªØ±
        iconSize: [38, 38], // Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¢ÛŒÚ©ÙˆÙ†
        iconAnchor: [19, 38], // Ù†Ù‚Ø·Ù‡ Ù„Ù†Ú¯Ø± Ø¢ÛŒÚ©ÙˆÙ† (Ù¾Ø§ÛŒÛŒÙ† ÙˆØ³Ø·)
        popupAnchor: [0, -35] // Ù†Ù‚Ø·Ù‡ Ø¨Ø§Ø² Ø´Ø¯Ù† Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ù†Ø³Ø¨Øª Ø¨Ù‡ Ø¢ÛŒÚ©ÙˆÙ†
    });
    // Ø§Ú¯Ø± Ø§Ø² Ø¢ÛŒÚ©ÙˆÙ† Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù‚Ø¨Ù„ÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯:
    // var busIcon = L.icon({ iconUrl: 'https://img.icons8.com/ios-filled/50/000000/bus.png', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -28] });


    function formatReadableTimestamp(isoString) {
        if (!isoString) return 'Ù†Ø§Ù…Ø´Ø®Øµ';
        try {
            const date = new Date(isoString);
            return date.toLocaleString('fa-IR', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        } catch (e) {
            console.warn("Ø®Ø·Ø§ Ø¯Ø± ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ®:", isoString, e);
            return 'Ù†Ø§Ù…Ø´Ø®Øµ';
        }
    }

    function updateMarkersForDevice(doc) {
        const locationData = doc.data();
        const deviceId = locationData.deviceId || doc.id; // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² deviceId ÛŒØ§ ID Ø¯Ø§Ú©ÛŒÙˆÙ…Ù†Øª
        const lat = locationData.latitude;
        const lng = locationData.longitude;
        const speed = locationData.speedKmph;
        const gpsTimestamp = locationData.gpsTimestamp; // Ø²Ù…Ø§Ù† Ø§Ø² GPS Ø¯Ø³ØªÚ¯Ø§Ù‡

        if (typeof lat !== 'number' || typeof lng !== 'number') {
            console.warn("Ø¯Ø§Ø¯Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯:", deviceId, locationData);
            return;
        }

        // Ø°Ø®ÛŒØ±Ù‡ Ø¢Ø®Ø±ÛŒÙ† Ø²Ù…Ø§Ù† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡
        lastDeviceUpdateTimes[deviceId] = new Date(gpsTimestamp || Date.now());
        updateOverallLastUpdated(); // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´Ú¯Ø± Ø¢Ø®Ø±ÛŒÙ† Ø²Ù…Ø§Ù† Ú©Ù„ÛŒ

        var latLng = L.latLng(lat, lng);
        var popupContent = `<b>ğŸšŒ Ø´Ù†Ø§Ø³Ù‡ Ø§ØªÙˆØ¨ÙˆØ³: ${deviceId}</b><br>
                            Ø³Ø±Ø¹Øª: ${speed !== undefined ? parseFloat(speed).toFixed(1) + ' km/h' : 'N/A'}<br>
                            Ø²Ù…Ø§Ù† GPS: ${formatReadableTimestamp(gpsTimestamp)}`;

        if (busMarkers[deviceId]) {
            busMarkers[deviceId].setLatLng(latLng).setPopupContent(popupContent);
        } else {
            busMarkers[deviceId] = L.marker(latLng, {icon: busIcon}).addTo(map).bindPopup(popupContent);
        }
    }

    function updateOverallLastUpdated() {
        let mostRecentTime = 0;
        for (const device in lastDeviceUpdateTimes) {
            if (lastDeviceUpdateTimes[device].getTime() > mostRecentTime) {
                mostRecentTime = lastDeviceUpdateTimes[device].getTime();
            }
        }

        const lastUpdatedElement = document.getElementById('lastUpdated');
        if (mostRecentTime > 0) {
            lastUpdatedElement.textContent = 'Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ù„ÛŒ: ' + new Date(mostRecentTime).toLocaleTimeString('fa-IR', {hour12: false});
        } else {
            lastUpdatedElement.textContent = 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...';
        }
    }

    locationsCollection.onSnapshot(snapshot => {
        let newOrModifiedDocs = false;
        snapshot.docChanges().forEach(change => {
            const doc = change.doc;
            const deviceId = doc.data().deviceId || doc.id;

            if (change.type === "added" || change.type === "modified") {
                newOrModifiedDocs = true;
                updateMarkersForDevice(doc);
            }
            if (change.type === "removed") {
                if (busMarkers[deviceId]) {
                    map.removeLayer(busMarkers[deviceId]);
                    delete busMarkers[deviceId];
                    delete lastDeviceUpdateTimes[deviceId]; // Ø­Ø°Ù Ø§Ø² Ù„ÛŒØ³Øª Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§
                    updateOverallLastUpdated(); // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´Ú¯Ø± Ø²Ù…Ø§Ù†
                }
            }
        });

        // ØªÙ†Ø¸ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± Ø²ÙˆÙ… Ùˆ Ù…Ø±Ú©Ø² Ù†Ù‚Ø´Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø§Ø±Ú©Ø±Ù‡Ø§
        if (newOrModifiedDocs && Object.keys(busMarkers).length > 0) {
           try {
               var group = new L.featureGroup(Object.values(busMarkers));
               map.fitBounds(group.getBounds().pad(0.3)); // pad Ø¨Ø±Ø§ÛŒ ÙØ§ØµÙ„Ù‡ Ø§Ø² Ù„Ø¨Ù‡â€ŒÙ‡Ø§
           } catch(e) {
               console.warn("Ø®Ø·Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ… Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ù†Ù‚Ø´Ù‡: ", e);
           }
        } else if (Object.keys(busMarkers).length === 0) {
            // Ø§Ú¯Ø± Ù‡ÛŒÚ† Ù…Ø§Ø±Ú©Ø±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø¨Ù‡ Ù†Ù…Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø±Ú¯Ø±Ø¯
            map.setView([32.4279, 53.6880], 6);
        }

    }, error => {
        console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÙ‡Ø§ Ø§Ø² Firestore: ", error);
        document.getElementById('lastUpdated').textContent = 'âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±.';
    });
</script>

</body>
</html>
