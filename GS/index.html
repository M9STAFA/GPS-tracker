<!DOCTYPE html>
<html lang="fa">
<head>
    <title>ردیاب هوشمند اتوبوس‌ها (پروژه bus-tracker-app-usb)</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1e1e2f; /* پس‌زمینه تیره مایل به سرمه‌ای */
            --surface-color: #27293d; /* سطح کمی روشن‌تر برای کارت‌ها و هدر/فوتر */
            --primary-accent: #6271c2; /* آبی بنفش برای تاکید */
            --secondary-accent: #ffc107; /* زرد کهربایی برای جزئیات خاص یا هشدارها (اختیاری) */
            --text-color: #e0e0e5; /* رنگ متن اصلی روشن */
            --text-color-muted: #a0a0b0; /* رنگ متن کم‌اهمیت‌تر */
            --border-color: #3a3c53; /* رنگ بوردرها */
            --border-radius: 8px;
            --header-height: 60px;
            --footer-height: 30px;
            --font-family: 'Vazirmatn', 'Tahoma', sans-serif;
            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.2);
            --shadow-strong: 0 6px 18px rgba(0, 0, 0, 0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            direction: rtl;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background-color: var(--surface-color);
            color: var(--text-color);
            padding: 0 20px;
            text-align: center;
            font-size: 1.5em; /* کمی کوچکتر برای ظرافت */
            font-weight: 600; /* وزن متوسط برای عنوان */
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid var(--border-color);
            /* box-shadow: var(--shadow-soft); */
        }
        .header-icon {
            font-size: 1.2em;
            margin-left: 10px;
            color: var(--primary-accent);
        }

        #map {
            height: calc(100vh - var(--header-height) - var(--footer-height));
            width: 100%;
            flex-grow: 1;
        }
        /* استایل برای زمانی که نقشه در حال بارگذاری است */
        #map:empty {
            background-color: #222; /* یک پس‌زمینه تیره برای نقشه قبل از بارگذاری */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: var(--text-color-muted);
        }
        #map:empty::before {
            content: "در حال بارگذاری نقشه...";
        }


        /* استایل پاپ‌آپ‌های Leaflet برای تم تیره */
        .leaflet-popup-content-wrapper {
            background: var(--surface-color) !important;
            color: var(--text-color) !important;
            border-radius: var(--border-radius) !important;
            box-shadow: var(--shadow-strong) !important;
            border: 1px solid var(--border-color);
        }
        .leaflet-popup-content {
            font-family: var(--font-family) !important;
            font-size: 14px !important;
            line-height: 1.7 !important;
            margin: 12px !important;
        }
        .leaflet-popup-content b {
            color: var(--primary-accent) !important;
            font-weight: 600;
        }
        .leaflet-popup-tip-container {
            /* برای مخفی کردن یا استایل دادن به پیکان پاپ‌آپ در صورت نیاز */
        }
        .leaflet-popup-tip {
            background: var(--surface-color) !important;
            border-bottom-color: var(--border-color) !important; /* اگر پیکان به پایین اشاره دارد */
        }
        .leaflet-container a.leaflet-popup-close-button {
            color: var(--text-color-muted) !important;
            padding: 8px 8px 0 0 !important;
        }
        .leaflet-container a.leaflet-popup-close-button:hover {
            color: var(--text-color) !important;
        }


        .last-updated-container {
            position: fixed;
            bottom: calc(var(--footer-height) + 12px);
            right: 12px;
            background-color: var(--surface-color);
            color: var(--text-color-muted);
            padding: 7px 15px;
            border-radius: var(--border-radius);
            font-size: 0.8em;
            z-index: 1000;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-soft);
            opacity: 0.9;
            transition: opacity 0.3s ease;
        }
        .last-updated-container:hover {
            opacity: 1;
        }

        .footer {
            background-color: var(--surface-color);
            color: var(--text-color-muted);
            padding: 0 20px;
            text-align: center;
            font-size: 0.75em; /* بسیار کوچک برای ظرافت */
            font-weight: 300; /* وزن سبک */
            height: var(--footer-height);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            border-top: 1px solid var(--border-color);
            z-index: 1001;
        }
    </style>
</head>
<body>

<div class="header">
    <span class="header-icon">🛰️</span> ردیاب هوشمند اتوبوس‌ها
</div>

<div id="map"></div>

<div id="lastUpdated" class="last-updated-container">⏳ در حال بارگذاری اولیه...</div>

<div class="footer">
    ساخته شده به دست دانشجویان دانشکده برق و کامپیوتر - نسخه 2.0
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyCCNBFlmY3akMMsNoGecKTrOR_LMaHJ-6A", // لطفاً کلید واقعی خود را جایگزین کنید
      authDomain: "bus-tracker-app-usb.firebaseapp.com",
      projectId: "bus-tracker-app-usb",
      storageBucket: "bus-tracker-app-usb.firebasestorage.app",
      messagingSenderId: "652452426183",
      appId: "1:652452426183:web:a0014cc421c727bf24a9e2",
      measurementId: "G-C218VLB61E"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const locationsCollection = db.collection("locations");

    var map = L.map('map', {
        // attributionControl: false // برای حذف Attribution از پایین نقشه اگر بخواهید
    }).setView([32.4279, 53.6880], 6);

    // استفاده از تایل‌های تیره برای نقشه (اختیاری، اما برای هماهنگی با تم تیره عالی است)
    // CartoDB Dark Matter:
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);
    // اگر تایل روشن استاندارد را ترجیح می‌دهید:
    // L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    //     maxZoom: 19,
    //     attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    // }).addTo(map);


    var busMarkers = {};
    const lastDeviceUpdateTimes = {};

    // استفاده از آیکون قبلی که نیاز به کلید ندارد
    var busIcon = L.icon({
        iconUrl: 'https://img.icons8.com/ios-filled/50/FFFFFF/bus.png', // آیکون سفید برای کنتراست با نقشه تیره یا روشن
        iconSize: [30, 30], // کمی کوچکتر
        iconAnchor: [15, 30],
        popupAnchor: [0, -28]
    });


    function formatReadableTimestamp(isoString) {
        if (!isoString) return 'نامشخص';
        try {
            const date = new Date(isoString);
            return date.toLocaleString('fa-IR', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        } catch (e) {
            console.warn("خطا در تبدیل تاریخ:", isoString, e);
            return 'نامشخص';
        }
    }

    function updateMarkersForDevice(doc) {
        const locationData = doc.data();
        const deviceId = locationData.deviceId || doc.id;
        const lat = locationData.latitude;
        const lng = locationData.longitude;
        const speed = locationData.speedKmph;
        const gpsTimestamp = locationData.gpsTimestamp;

        if (typeof lat !== 'number' || typeof lng !== 'number') {
            console.warn("داده موقعیت نامعتبر:", deviceId, locationData);
            return;
        }

        lastDeviceUpdateTimes[deviceId] = new Date(gpsTimestamp || Date.now());
        updateOverallLastUpdated();

        var latLng = L.latLng(lat, lng);
        var popupContent = `<b><span style="font-size: 1.1em;">شناسه اتوبوس: ${deviceId}</span></b><br>
                            سرعت: ${speed !== undefined ? parseFloat(speed).toFixed(1) + ' km/h' : 'N/A'}<br>
                            زمان GPS: ${formatReadableTimestamp(gpsTimestamp)}`;

        if (busMarkers[deviceId]) {
            busMarkers[deviceId].setLatLng(latLng).setPopupContent(popupContent);
        } else {
            busMarkers[deviceId] = L.marker(latLng, {icon: busIcon}).addTo(map).bindPopup(popupContent);
        }
    }

    function updateOverallLastUpdated() {
        let mostRecentTime = 0;
        for (const device in lastDeviceUpdateTimes) {
            if (lastDeviceUpdateTimes[device].getTime() > mostRecentTime) {
                mostRecentTime = lastDeviceUpdateTimes[device].getTime();
            }
        }

        const lastUpdatedElement = document.getElementById('lastUpdated');
        if (mostRecentTime > 0) {
            lastUpdatedElement.textContent = 'آخرین بروزرسانی: ' + new Date(mostRecentTime).toLocaleTimeString('fa-IR', {hour12: false});
        } else {
            lastUpdatedElement.textContent = 'در انتظار داده...';
        }
    }

    locationsCollection.onSnapshot(snapshot => {
        let newOrModifiedDocs = false;
        snapshot.docChanges().forEach(change => {
            const doc = change.doc;
            const deviceId = doc.data().deviceId || doc.id;

            if (change.type === "added" || change.type === "modified") {
                newOrModifiedDocs = true;
                updateMarkersForDevice(doc);
            }
            if (change.type === "removed") {
                if (busMarkers[deviceId]) {
                    map.removeLayer(busMarkers[deviceId]);
                    delete busMarkers[deviceId];
                    delete lastDeviceUpdateTimes[deviceId];
                    updateOverallLastUpdated();
                }
            }
        });

        if (newOrModifiedDocs && Object.keys(busMarkers).length > 0) {
           try {
               var group = new L.featureGroup(Object.values(busMarkers));
               map.fitBounds(group.getBounds().pad(0.25)); // پدینگ کمتر برای حس فیت‌تر بودن
           } catch(e) {
               console.warn("خطا در تنظیم محدوده نقشه: ", e);
           }
        } else if (Object.keys(busMarkers).length === 0) {
            map.setView([32.4279, 53.6880], 6);
        }

    }, error => {
        console.error("خطا در Firestore: ", error);
        document.getElementById('lastUpdated').textContent = '⚠️ خطا در ارتباط.';
    });
</script>

</body>
</html>
