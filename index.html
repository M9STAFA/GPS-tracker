<!DOCTYPE html>
<html>
<head>
    <title>GPS Tracker - Supabase</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Supabase.js SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        #map { height: calc(100vh - 70px); width: 100%; }
        body { font-family: 'Tahoma', sans-serif; margin:0; padding:0; direction: rtl; }
        .header { background-color: #3ecf8e; color: white; padding: 15px; text-align: center; font-size: 1.5em; }
        .leaflet-popup-content { font-size: 14px; }
        .status-bar { position: fixed; bottom: 10px; left: 10px; background-color: rgba(255, 255, 255, 0.85); padding: 8px 12px; border-radius: 5px; font-size: 13px; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
<div class="header">ردیاب آنلاین اتوبوس‌هاo (Supabase)</div>
<div id="map"></div>
<div id="statusBar" class="status-bar">در حال اتصال به Supabase...</div>

<script>
    const SUPABASE_URL = 'https://xqwgojhhzicequgakcpy.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhxd2dvamhoemljZXF1Z2FrY3B5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1MzY1NTAsImV4cCI6MjA2NDExMjU1MH0.znQuBZ8TVCpBR2IIFdM5x01544YChViJirP_Ia_wKZM';

    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const mapElement = document.getElementById('map');
    const statusBarElement = document.getElementById('statusBar');
    var map = L.map(mapElement).setView([32.4279, 53.6880], 6); // مرکز ایران

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© <a href="https://openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var busMarkers = {}; // { deviceId: L.Marker }

    function updateStatusBar(message, isError = false) {
        statusBarElement.textContent = message;
        statusBarElement.style.color = isError ? 'red' : 'black';
    }

    async function fetchAndUpdateMarkers() {
        updateStatusBar('در حال دریافت آخرین موقعیت‌ها...');
        const { data, error } = await _supabase
            .from('locations')
            .select('device_id, latitude, longitude, speed_kmph, gps_timestamp, created_at')
            .order('created_at', { ascending: false })
            .limit(100);

        if (error) {
            console.error('Error fetching locations:', error);
            updateStatusBar(`خطا در دریافت داده: ${error.message}`, true);
            return;
        }

        if (data && data.length > 0) {
            const latestDeviceData = {};
            data.forEach(loc => {
                if (!latestDeviceData[loc.device_id]) {
                    latestDeviceData[loc.device_id] = loc;
                }
            });

            let markersUpdatedCount = 0;
            Object.values(latestDeviceData).forEach(location => {
                if (!location.latitude || !location.longitude) {
                    console.warn("داده موقعیت نامعتبر برای دستگاه:", location.device_id, location);
                    return;
                }
                markersUpdatedCount++;
                var deviceId = location.device_id;
                var latLng = [location.latitude, location.longitude];
                var popupContent = `<b>اتوبوس: ${deviceId}</b><br>
                                    سرعت: ${location.speed_kmph != null ? parseFloat(location.speed_kmph).toFixed(1) + ' km/h' : 'N/A'}<br>
                                    زمان GPS: ${location.gps_timestamp ? new Date(location.gps_timestamp).toLocaleString('fa-IR') : 'N/A'}<br>
                                    ثبت در: ${new Date(location.created_at).toLocaleString('fa-IR')}`;

                if (busMarkers[deviceId]) {
                    busMarkers[deviceId].setLatLng(latLng).setPopupContent(popupContent);
                } else {
                    var busIcon = L.icon({ iconUrl: 'https://img.icons8.com/ios-filled/50/000000/bus.png', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -28] });
                    busMarkers[deviceId] = L.marker(latLng, {icon: busIcon}).addTo(map).bindPopup(popupContent);
                }
            });

            if (markersUpdatedCount > 0 && Object.keys(busMarkers).length > 0) {
               try {
                   var group = new L.featureGroup(Object.values(busMarkers));
                   map.fitBounds(group.getBounds().pad(0.3));
               } catch(e) {
                   console.warn("خطا در تنظیم محدوده نقشه:", e);
               }
            }
            updateStatusBar(`آخرین بروزرسانی: ${new Date().toLocaleTimeString('fa-IR')} - ${markersUpdatedCount} دستگاه نمایش داده شد.`);
        } else if (data && data.length === 0) {
            updateStatusBar('هنوز هیچ داده‌ای برای نمایش وجود ندارد.');
        }
    }

    const realtimeChannel = _supabase.channel('public:locations')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'locations' },
        (payload) => {
          console.log('تغییر در Supabase دریافت شد:', payload);
          updateStatusBar('داده جدید دریافت شد، در حال بروزرسانی نقشه...');
          fetchAndUpdateMarkers();
        }
      )
      .subscribe((status, err) => {
        if (status === 'SUBSCRIBED') {
          console.log('با موفقیت به تغییرات بلادرنگ Supabase متصل شد!');
          updateStatusBar('متصل شد! در انتظار دریافت موقعیت‌ها...');
          fetchAndUpdateMarkers();
        } else if (status === 'CHANNEL_ERROR') {
            console.error('خطا در کانال بلادرنگ Supabase:', err);
            updateStatusBar(`خطا در اتصال بلادرنگ: ${err ? err.message : 'خطای نامشخص'}`, true);
        } else if (status === 'TIMED_OUT') {
            console.warn('اتصال بلادرنگ Supabase منقضی شد.');
            updateStatusBar('اتصال بلادرنگ منقضی شد. تلاش مجدد...', true);
        } else {
            console.log('وضعیت کانال بلادرنگ Supabase:', status);
        }
      });

    // اگر نمی‌خواهید از بلادرنگ استفاده کنید:
    // fetchAndUpdateMarkers();
    // setInterval(fetchAndUpdateMarkers, 20000);

</script>
</body>
</html>
